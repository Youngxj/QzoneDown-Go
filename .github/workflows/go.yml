# This workflow will build a golang project
# For more information see: https://docs.github.com/en/actions/automating-builds-and-tests/building-and-testing-go

name: Go

on:
  push:
    tags:
      - v*

jobs:

  # æž„å»ºä¸»ç¨‹åºï¼ˆCLIç‰ˆæœ¬ï¼‰
  build-cli:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod" # ä½¿ç”¨ go.mod æ–‡ä»¶ä¸­çš„ golang ç‰ˆæœ¬

      - name: Build CLI version
        uses: goreleaser/goreleaser-action@v6
        with:
          distribution: goreleaser
          version: latest
          args: release --clean --config .goreleaser.yaml
        env:
          GITHUB_TOKEN: ${{ secrets.GH_ACCESS_TOKEN }}

  # æž„å»ºGUIç¨‹åºï¼ˆFyneç‰ˆæœ¬ï¼‰
  build-gui:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ ubuntu-latest, windows-latest, macos-latest ]
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Go
        uses: actions/setup-go@v5
        with:
          go-version-file: "go.mod"

      # å®‰è£…GUIä¾èµ–
      - name: Install GUI dependencies (Linux)
        if: matrix.os == 'ubuntu-latest'
        run: |
          sudo apt-get update
          sudo apt-get install -y libgl1-mesa-dev libxcursor-dev libxinerama-dev libxi-dev

      - name: Install GUI dependencies (macOS)
        if: matrix.os == 'macos-latest'
        run: |
          # macOSé€šå¸¸ä¸éœ€è¦é¢å¤–å®‰è£…GUIä¾èµ–

      - name: Install GUI dependencies (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          # Windowsé€šå¸¸ä¸éœ€è¦é¢å¤–å®‰è£…GUIä¾èµ–

      # è®¾ç½®CGOçŽ¯å¢ƒå˜é‡
      - name: Set CGO environment
        run: |
          echo "CGO_ENABLED=1" >> $GITHUB_ENV

      # æž„å»ºGUIç‰ˆæœ¬
      - name: Build GUI version
        env:
          CGO_ENABLED: 1
        run: |
          cd gui
          go build -o ../build/gui/QzoneDown-GUI-${{ runner.os }}-amd64 .

      # æ‰“åŒ…GUIç‰ˆæœ¬
      - name: Package GUI version
        run: |
          cd build/gui
          # æ ¹æ®æ“ä½œç³»ç»Ÿåˆ›å»ºä¸åŒçš„åŒ…
          if [ "${{ runner.os }}" == "Linux" ]; then
            tar -czf QzoneDown-GUI-linux-amd64.tar.gz QzoneDown-GUI-Linux-amd64
            echo "PACKAGE_NAME=QzoneDown-GUI-linux-amd64.tar.gz" >> $GITHUB_ENV
          elif [ "${{ runner.os }}" == "macOS" ]; then
            tar -czf QzoneDown-GUI-darwin-amd64.tar.gz QzoneDown-GUI-Darwin-amd64
            echo "PACKAGE_NAME=QzoneDown-GUI-darwin-amd64.tar.gz" >> $GITHUB_ENV
          elif [ "${{ runner.os }}" == "Windows" ]; then
            7z a -tzip QzoneDown-GUI-windows-amd64.zip QzoneDown-GUI-Windows-amd64.exe
            echo "PACKAGE_NAME=QzoneDown-GUI-windows-amd64.zip" >> $GITHUB_ENV
          fi

      # ä¸Šä¼ æž„å»ºäº§ç‰©
      - name: Upload GUI artifacts
        uses: actions/upload-artifact@v4
        with:
          name: QzoneDown-GUI-${{ runner.os }}-amd64
          path: build/gui/${{ env.PACKAGE_NAME }}

      # åˆ›å»ºReleaseå¹¶ä¸Šä¼ GUIç‰ˆæœ¬
      - name: Upload GUI to Release
        uses: svenstaro/upload-release-action@v2
        with:
          repo_token: ${{ secrets.GITHUB_TOKEN }}
          file: build/gui/${{ env.PACKAGE_NAME }}
          asset_name: ${{ env.PACKAGE_NAME }}
          tag: ${{ github.ref }}
          overwrite: true

  # åˆ›å»ºReleaseè¯´æ˜Ž
  create-release:
    needs: [ build-cli, build-gui ]
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Generate Release Notes
        id: release_notes
        run: |
          # ä»Žgit tagç”Ÿæˆrelease notes
          echo "## ðŸš€ QzoneDown-Go Release ${{ github.ref_name }}" > release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“¦ ä¸‹è½½åœ°å€" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### CLIç‰ˆæœ¬ï¼ˆå‘½ä»¤è¡Œå·¥å…·ï¼‰" >> release_notes.md
          echo "- [Linuxç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/download/${{ github.ref }}/QzoneDown-Go_Linux_x86_64.tar.gz)" >> release_notes.md
          echo "- [Windowsç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/download/${{ github.ref }}/QzoneDown-Go_Windows_x86_64.zip)" >> release_notes.md
          echo "- [macOSç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/download/${{ github.ref }}/QzoneDown-Go_Darwin_x86_64.tar.gz)" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### GUIç‰ˆæœ¬ï¼ˆå›¾å½¢ç•Œé¢ï¼‰" >> release_notes.md
          echo "- [Linux GUIç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/download/${{ github.ref }}/QzoneDown-GUI-linux-amd64.tar.gz)" >> release_notes.md
          echo "- [Windows GUIç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/download/${{ github.ref }}/QzoneDown-GUI-windows-amd64.zip)" >> release_notes.md
          echo "- [macOS GUIç‰ˆæœ¬](https://github.com/${{ github.repository }}/releases/download/${{ github.ref }}/QzoneDown-GUI-darwin-amd64.tar.gz)" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ“‹ ä½¿ç”¨è¯´æ˜Ž" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### CLIç‰ˆæœ¬" >> release_notes.md
          echo "\`\`\`bash" >> release_notes.md
          echo "# ä¸‹è½½å¹¶è§£åŽ‹åŽè¿è¡Œ" >> release_notes.md
          echo "./QzoneDown-Go" >> release_notes.md
          echo "\`\`\`" >> release_notes.md
          echo "" >> release_notes.md
          echo "#### GUIç‰ˆæœ¬" >> release_notes.md
          echo "1. ä¸‹è½½å¯¹åº”ç³»ç»Ÿçš„GUIç‰ˆæœ¬" >> release_notes.md
          echo "2. è§£åŽ‹æ–‡ä»¶" >> release_notes.md
          echo "3. è¿è¡Œå¯æ‰§è¡Œæ–‡ä»¶" >> release_notes.md
          echo "" >> release_notes.md
          echo "### ðŸ”§ ç³»ç»Ÿè¦æ±‚" >> release_notes.md
          echo "- **CLIç‰ˆæœ¬**: Go 1.19+ çŽ¯å¢ƒ" >> release_notes.md
          echo "- **GUIç‰ˆæœ¬**: " >> release_notes.md
          echo "  - Linux: éœ€è¦libgl1-mesa-devç­‰GUIåº“" >> release_notes.md
          echo "  - Windows: æ— ç‰¹æ®Šè¦æ±‚" >> release_notes.md
          echo "  - macOS: æ— ç‰¹æ®Šè¦æ±‚" >> release_notes.md

      - name: Update Release
        uses: softprops/action-gh-release@v2
        with:
          body_path: release_notes.md
          files: |
            build/gui/QzoneDown-GUI-linux-amd64.tar.gz
            build/gui/QzoneDown-GUI-windows-amd64.zip
            build/gui/QzoneDown-GUI-darwin-amd64.tar.gz
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}